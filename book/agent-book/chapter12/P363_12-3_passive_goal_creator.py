"""
Title   : LangChainã¨LangGraphã«ã‚ˆã‚‹RAGãƒ»AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè·µå…¥é–€
Chapter : 12 ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³
Section : 3 ãƒ‘ãƒƒã‚·ãƒ–ã‚´ãƒ¼ãƒ«ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼
Theme   : 
Date    : 2025/00/00
Page    : P366-368
"""


# ï¼œæ¦‚è¦ï¼
# - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‹ã‚‰å…·ä½“çš„ãªç›®æ¨™ã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
# - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç„¶è¨€èªã§å…¥åŠ›ã™ã‚‹æŒ‡ç¤ºã¯æ›–æ˜§ã§ã ã£ãŸã‚Šã€æ„å›³ã›ãšè¤‡æ•°ã®ç›®æ¨™ãŒå«ã¾ã‚ŒãŸã‚Šã™ã‚‹
# - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯æ›–æ˜§ãªè³ªå•ã‚’åˆ†è§£ã—ã¦æ˜ç¢ºãªç›®æ¨™ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
# - ãƒ‘ãƒƒã‚·ãƒ–ã‚´ãƒ¼ãƒ«ãƒ»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæä¾›ã—ãŸæƒ…å ±ã®ã¿ã«åŸºã¥ãï¼ˆéå»ã®è¡Œå‹•å±¥æ­´ã‚„å¤–éƒ¨ç’°å¢ƒã¯å‚ç…§ã—ãªã„ï¼‰

# ï¼œãƒ—ãƒ­ã‚»ã‚¹ï¼
# - 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å…¥åŠ›ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§å—ã‘å–ã‚‹
# - 2. LLMã‚’ç”¨ã„ã¦ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å«ã¾ã‚Œã‚‹ç›®æ¨™/è¦æ±‚ã‚’æŠ½å‡ºã™ã‚‹
# - 3. ç‰¹å®šã•ã‚ŒãŸç›®æ¨™ã‚’æ§‹é€ åŒ–ã•ã‚ŒãŸå½¢å¼(Pydantic)ã«å¤‰æ›ã™ã‚‹
# - 4. å¿…è¦ã«å¿œã˜ã¦ç›®æ¨™ã®å„ªå…ˆé †ä½ä»˜ã‘ã‚„ä¾å­˜é–¢ä¿‚ã®ç‰¹å®šã‚’è¡Œã†
# - 5. æ§‹é€ åŒ–ã•ã‚ŒãŸç›®æ¨™ã‚’AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«æ¸¡ã™


from settings import Settings
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI
from pydantic import BaseModel, Field


class Goal(BaseModel):
    description: str = Field(..., description="ç›®æ¨™ã®èª¬æ˜")

    @property
    def text(self) -> str:
        return f"{self.description}"


class PassiveGoalCreator:
    def __init__(self, llm: ChatOpenAI):
        self.llm = llm

    def run(self, query: str) -> Goal:
        prompt = ChatPromptTemplate.from_template(
            template="""
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’åˆ†æã—ã€æ˜ç¢ºã§å®Ÿè¡Œå¯èƒ½ãªç›®æ¨™ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            è¦ä»¶:
            1. ç›®æ¨™ã¯å…·ä½“çš„ã‹ã¤æ˜ç¢ºã§ã‚ã‚Šã€å®Ÿè¡Œå¯èƒ½ãªãƒ¬ãƒ™ãƒ«ã§è©³ç´°åŒ–ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
            2. ã‚ãªãŸãŒå®Ÿè¡Œå¯èƒ½ãªè¡Œå‹•ã¯ä»¥ä¸‹ã®è¡Œå‹•ã ã‘ã§ã™ã€‚
               - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’åˆ©ç”¨ã—ã¦ã€ç›®æ¨™ã‚’é”æˆã™ã‚‹ãŸã‚ã®èª¿æŸ»ã‚’è¡Œã†ã€‚
               - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŸã‚ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚
            3. æ±ºã—ã¦2.ä»¥å¤–ã®è¡Œå‹•ã‚’å–ã£ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚

            ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›: {query}
            """
        )
        chain = prompt | self.llm.with_structured_output(Goal)
        return chain.invoke(input={"query": query})


def main():

    # ç’°å¢ƒè¨­å®š
    settings = Settings()
    
    # LLMã®å®šç¾©
    llm = ChatOpenAI(
        model=settings.openai_smart_model,
        temperature=settings.temperature
    )
    
    # ãƒ‘ãƒƒã‚·ãƒ–ã‚´ãƒ¼ãƒ«ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã®å®Ÿè¡Œ
    # --- è³ªå•ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«è³ªå•ã‚’LLMã§æ˜ã‚Šä¸‹ã’ã‚‹
    # --- è³ªå• â‡’ æ˜ç¢ºã§å®Ÿè¡Œå¯èƒ½ãªç›®æ¨™ã€ã«å¤‰æ›ã™ã‚‹
    task_input = "Slacké€£æºã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’ä½œã‚ŠãŸã„"
    goal_creator = PassiveGoalCreator(llm=llm)
    result = goal_creator.run(query=task_input)
    
    # çµæœç¢ºèª
    print(f"ğŸ” ç”Ÿæˆã•ã‚ŒãŸç›®æ¨™: {result.text}")


if __name__ == "__main__":
    main()